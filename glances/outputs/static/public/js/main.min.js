var glancesApp = angular.module('glancesApp', ['ngRoute', 'glances.config', 'fps.hotkeys'])

.value('CONFIG', {})
.value('ARGUMENTS', {})

.run(["$rootScope", function($rootScope) {
      $rootScope.title = "Glances";
}]);

glancesApp.directive("sortableTh", function() {
    return {
        restrict: 'A',
        scope: {
            sorter: '='
        },
        link: function (scope, element, attrs) {

            element.addClass('sortable');

            scope.$watch(function() {
                return scope.sorter.column;
            }, function(newValue, oldValue) {

                if (angular.isArray(newValue)) {
                    if (newValue.indexOf(attrs.column) !== -1) {
                        element.addClass('sort');
                    } else {
                        element.removeClass('sort');
                    }
                } else {
                    if (attrs.column === newValue) {
                        element.addClass('sort');
                    } else {
                        element.removeClass('sort');
                    }
                }

            });

            element.on('click', function() {

                scope.sorter.column = attrs.column;

                scope.$apply();
            });
        }
    };
});
glancesApp.filter('min_size', function() {
    return function(input, max) {
        var max = max || 8;
        if (input.length > max) {
            return "_" + input.substring(input.length - max)
        }
        return input
    };
});
glancesApp.filter('exclamation', function() {
    return function(input) {
        if (input === undefined || input === '') {
            return '?';
        }
        return input;
    };
});

glancesApp.filter('bytes', function() {
    return function (bytes, low_precision) {
        low_precision = low_precision || false;
        if (isNaN(parseFloat(bytes)) || !isFinite(bytes) || bytes == 0){
            return bytes;
        }

        var symbols = ['K', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'];
        var prefix = {
          'Y': 1208925819614629174706176,
          'Z': 1180591620717411303424,
          'E': 1152921504606846976,
          'P': 1125899906842624,
          'T': 1099511627776,
          'G': 1073741824,
          'M': 1048576,
          'K': 1024
        };

        var reverseSymbols = _(symbols).reverse().value();
        for (var i = 0; i < reverseSymbols.length; i++) {
          var symbol = reverseSymbols[i];
          var value = bytes / prefix[symbol];

          if(value > 1) {
            var decimal_precision = 0;

            if(value < 10) {
              decimal_precision = 2;
            }
            else if(value < 100) {
              decimal_precision = 1;
            }

            if(low_precision) {
              if(symbol == 'MK') {
                decimal_precision = 0;
              }
              else {
                decimal_precision = _.min([1, decimal_precision]);
              }
            }
            else if(symbol == 'K') {
              decimal_precision = 0;
            }

            return parseFloat(value).toFixed(decimal_precision) + symbol;
          }
        }

        return bytes.toFixed(0);
    }
});

glancesApp.filter('bits', ["$filter", function($filter) {
    return function (bits, low_precision) {
      bits = Math.round(bits) * 8;
      return $filter('bytes')(bits, low_precision) + 'b';
    }
}]);

glancesApp.filter('leftPad', function() {
    return function (value, length, chars) {
      length = length || 0;
      chars = chars || ' ';
      return _.padStart(value, length, chars);
    }
});

glancesApp.filter('timemillis', function() {
    return function (array) {
      var sum = 0.0;
      for (var i = 0; i < array.length; i++) {
          sum += array[i] * 1000.0;
      }
      return sum;
    }
});

glancesApp.filter('timedelta', ["$filter", function($filter) {
    return function (value) {
      var sum = $filter('timemillis')(value);
      var d = new Date(sum);

      return {
        hours: d.getUTCHours(), // TODO : multiple days ( * (d.getDay() * 24)))
        minutes: d.getUTCMinutes(),
        seconds: d.getUTCSeconds(),
        milliseconds: parseInt("" + d.getUTCMilliseconds() / 10)
      };
    }
}]);

glancesApp.service('favicoService', function() {

  var favico = new Favico({
    animation : 'none'
  });

  this.badge = function(nb) {
    favico.badge(nb);
  };

  this.reset = function() {
    favico.reset();
  };
});

glancesApp.service('GlancesPluginHelper', function () {

    var plugin = {
        'limits': {},
        'limitSuffix': ['critical', 'careful', 'warning']
    };

    plugin.setLimits = function(limits){
        this.limits = limits;
    };

    plugin.getAlert = function (pluginName, limitNamePrefix, current, maximum, log) {
        current = current || 0;
        maximum = maximum || 100;
        log = log || false;

        var log_str = log ? '_log' : '';
        var value = (current * 100) / maximum;

        if (this.limits[pluginName] != undefined) {
            for (var i = 0; i < this.limitSuffix.length; i++) {
                var limitName = limitNamePrefix + this.limitSuffix[i];
                var limit = this.limits[pluginName][limitName];

                if (value >= limit) {
                    var pos = limitName.lastIndexOf("_");
                    var className = limitName.substring(pos + 1);

                    return className + log_str;
                }
            }
        }

        return "ok" + log_str;
    };

    plugin.getAlertLog = function (pluginName, limitNamePrefix, current, maximum) {
        return this.getAlert(pluginName, limitNamePrefix, current, maximum, true);
    };

    return plugin;
});

glancesApp.service('GlancesStats', ["$http", "$q", "GlancesPluginHelper", "CONFIG", "ARGUMENTS", function($http, $q, GlancesPluginHelper, CONFIG, ARGUMENTS) {

    this.getData = function() {
        return $q.all([
            this.getAllStats(),
            this.getAllViews()
        ]).then(function(results) {
            return {
                'stats': results[0],
                'view': results[1],
                'isBsd': results[0]['system']['os_name'] === 'FreeBSD',
                'isLinux': results[0]['system']['os_name'] === 'Linux',
                'isMac': results[0]['system']['os_name'] === 'Darwin',
                'isWindows': results[0]['system']['os_name'] === 'Windows'
            };
        });
    };

    this.getAllStats = function() {
        return $http.get('api/2/all').then(function (response) {
            return response.data;
        });
    };

    this.getAllViews = function() {
        return $http.get('api/2/all/views').then(function (response) {
            return response.data;
        });
    };

    this.getHelp = function() {
        return $http.get('api/2/help').then(function (response) {
            return response.data;
        });
    };

    // load limits to init GlancePlugin helper
    $http.get('api/2/all/limits').then(function (response) {
      GlancesPluginHelper.setLimits(response.data);
    });
    $http.get('api/2/config').then(function (response) {
        angular.extend(CONFIG, response.data);
    });
    $http.get('api/2/args').then(function (response) {
        angular.extend(ARGUMENTS, response.data);
    });

}]);

'use strict';

glancesApp.component('glances', {
    controller: GlancesController,
    controllerAs: 'vm',
    templateUrl: 'components/glances/view.html'
});

'use strict';

function GlancesController($scope, $rootScope, $timeout, GlancesStats, REFRESH_TIME, Hotkeys, ARGUMENTS) {
    var vm = this;
    vm.dataLoaded = false;
    vm.arguments = ARGUMENTS;

    vm.refreshData = function () {
        GlancesStats.getData().then(function (data) {
            $rootScope.title = data.stats.system.hostname + ' - Glances';
            $scope.$broadcast('data_refreshed', data);
            vm.dataLoaded = true;

            nextLoad();
        }, function() {
            $scope.$broadcast('is_disconnected');
            nextLoad();
        });
    };

    var loadPromise;
    var cancelNextLoad = function() {
      $timeout.cancel(loadPromise);
    };

    var nextLoad = function() {
      cancelNextLoad();
      loadPromise = $timeout(vm.refreshData, REFRESH_TIME * 1000); // in milliseconds
    };

    vm.refreshData();

    Hotkeys.registerHotkey(Hotkeys.createHotkey({
        key: 'm',
        callback: function () {
          console.log('Sort processes by MEM%');
        }
    }));
}

'use strict';

glancesApp.component('glancesHelp', {
    controller: GlancesHelpController,
    controllerAs: 'vm',
    templateUrl: 'components/help/view.html'
});

'use strict';

function GlancesHelpController(GlancesStats) {
    var vm = this;

    GlancesStats.getHelp().then(function(help) {
        vm.help = help;
    });
}

'use strict';

glancesApp.component('glancesPluginAlert', {
    controller: GlancesPluginAlertController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-alert/view.html'
});

'use strict';

function GlancesPluginAlertController($scope, favicoService) {
    var vm = this;
    var _alerts = [];

    $scope.$on('alertStats_refreshed', function(event, data) {
      var alertStats = stats.stats['alert'];
      _alerts = [];

      if(!_.isArray(alertStats)) {
          alertStats = [];
      }

      for (var i = 0; i < alertStats.length; i++) {
          var alertalertStats = alertStats[i];
          var alert = {};

          alert.name = alertalertStats[3];
          alert.level = alertalertStats[2];
          alert.begin = alertalertStats[0] * 1000;
          alert.end = alertalertStats[1] * 1000;
          alert.ongoing = alertalertStats[1] == -1;
          alert.min = alertalertStats[6];
          alert.mean = alertalertStats[5];
          alert.max = alertalertStats[4];

          if (!alert.ongoing) {
              var duration = alert.end - alert.begin;
              var seconds = parseInt((duration / 1000) % 60)
                  , minutes = parseInt((duration / (1000 * 60)) % 60)
                  , hours = parseInt((duration / (1000 * 60 * 60)) % 24);

              alert.duration = _.padStart(hours, 2, '0') + ":" + _.padStart(minutes, 2, '0') + ":" + _.padStart(seconds, 2, '0');
          }

          _alerts.push(alert);
      }

      if (vm.hasOngoingAlerts()) {
          favicoService.badge(vm.countOngoingAlerts());
      } else {
          favicoService.reset();
      }
    });

    vm.hasAlerts = function () {
        return _alerts.length > 0;
    };

    vm.getAlerts = function () {
        return _alerts;
    };

    vm.count = function () {
        return _alerts.length;
    };

    vm.hasOngoingAlerts = function () {
        return _.filter(_alerts, { 'ongoing': true }).length > 0;
    };

    vm.countOngoingAlerts = function () {
        return _.filter(_alerts, { 'ongoing': true }).length;
    }
}

'use strict';

glancesApp.component('glancesPluginCloud', {
    controller: GlancesPluginCloudController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-cloud/view.html'
});

'use strict';

function GlancesPluginCloudController($scope) {
    var vm = this;

    vm.provider = null;
    vm.instance = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['cloud'];

      if (stats['ami-id'] !== undefined) {
          vm.provider = 'AWS EC2';
          vm.instance =  stats['instance-type'] + ' instance ' + stats['instance-id'] + ' (' + stats['region'] + ')';
      }
    });
}

'use strict';

glancesApp.component('glancesPluginCpu', {
    controller: GlancesPluginCpuController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-cpu/view.html'
});

'use strict';

function GlancesPluginCpuController($scope) {
    var vm = this;
    var _view = {};

    vm.total = null;
    vm.user = null;
    vm.system = null;
    vm.idle = null;
    vm.nice = null;
    vm.irq = null;
    vm.iowait = null;
    vm.steal = null;
    vm.ctx_switches = null;
    vm.interrupts = null;
    vm.soft_interrupts = null;
    vm.syscalls = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['cpu'];
      _view = data.view['cpu'];

      vm.total = stats.total;
      vm.user = stats.user;
      vm.system = stats.system;
      vm.idle = stats.idle;
      vm.nice = stats.nice;
      vm.irq = stats.irq;
      vm.iowait = stats.iowait;
      vm.steal = stats.steal;

      if (stats.ctx_switches) {
          vm.ctx_switches = Math.floor(stats.ctx_switches / stats.time_since_update);
      }

      if (stats.interrupts) {
          vm.interrupts = Math.floor(stats.interrupts / stats.time_since_update);
      }

      if (stats.soft_interrupts) {
          vm.soft_interrupts = Math.floor(stats.soft_interrupts / stats.time_since_update);
      }

      if (stats.syscalls) {
          vm.syscalls = Math.floor(stats.syscalls / stats.time_since_update);
      }
    });

    this.getDecoration = function (value) {
        if (_view[value] === undefined) {
            return;
        }

        return _view[value].decoration.toLowerCase();
    };
}

'use strict';

glancesApp.component('glancesPluginDiskio', {
    controller: GlancesPluginDiskioController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-diskio/view.html'
});

'use strict';

function GlancesPluginDiskioController($scope, $filter, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;

    vm.disks = [];

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['diskio'];
      stats = $filter('orderBy')(stats,'disk_name');

      vm.disks = [];
      for (var i = 0; i < stats.length; i++) {
          var diskioData = stats[i];
          var timeSinceUpdate = diskioData['time_since_update'];

          vm.disks.push({
              'name': diskioData['disk_name'],
              'bitrate': {
                  'txps': $filter('bytes')(diskioData['read_bytes'] / timeSinceUpdate),
                  'rxps': $filter('bytes')(diskioData['write_bytes'] / timeSinceUpdate)
              },
              'count': {
                  'txps': $filter('bytes')(diskioData['read_count'] / timeSinceUpdate),
                  'rxps': $filter('bytes')(diskioData['write_count'] / timeSinceUpdate)
              },
              'alias': diskioData['alias'] !== undefined ? diskioData['alias'] : null
          });
      }
    });
}

'use strict';

glancesApp.component('glancesPluginFs', {
    controller: GlancesPluginFsController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-fs/view.html'
});

'use strict';

function GlancesPluginFsController($scope, $filter, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;
    var _view = {};

    vm.fileSystems = [];

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['fs'];
      _view = data.view['fs'];

      vm.fileSystems = [];
      for (var i = 0; i < stats.length; i++) {
          var fsData = stats[i];

          var shortMountPoint = fsData['mnt_point'];
          if (shortMountPoint.length > 9) {
              shortMountPoint = '_' + fsData['mnt_point'].slice(-8);
          }

          vm.fileSystems.push(fs = {
              'name': fsData['device_name'],
              'mountPoint': fsData['mnt_point'],
              'shortMountPoint': shortMountPoint,
              'percent': fsData['percent'],
              'size': fsData['size'],
              'used': fsData['used'],
              'free': fsData['free']
          });
      }

      vm.fileSystems = $filter('orderBy')(vm.fileSystems,'mnt_point');
    });

    vm.getDecoration = function(mountPoint, field) {
        if(_view[mountPoint][field] == undefined) {
            return;
        }

        return _view[mountPoint][field].decoration.toLowerCase();
    };
}

'use strict';

glancesApp.component('glancesPluginIp', {
    controller: GlancesPluginIpController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-ip/view.html'
});

'use strict';

function GlancesPluginIpController($scope, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;

    vm.address = null;
    vm.gateway = null;
    vm.mask = null;
    vm.maskCidr = null;
    vm.publicAddress = null;

    $scope.$on('data_refreshed', function(event, data) {
      var ipStats = data.stats['ip'];

      vm.address = ipStats.address;
      vm.gateway = ipStats.gateway;
      vm.mask = ipStats.mask;
      vm.maskCidr = ipStats.mask_cidr;
      vm.publicAddress = ipStats.public_address
    });
}

'use strict';

glancesApp.component('glancesPluginLoad', {
    controller: GlancesPluginLoadController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-load/view.html'
});

'use strict';

function GlancesPluginLoadController($scope) {
    var vm = this;
    var _view = {};

    vm.cpucore = null;
    vm.min1 = null;
    vm.min5 = null;
    vm.min15 = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['load'];
      _view = data.view['load'];

      vm.cpucore = stats['cpucore'];
      vm.min1 = stats['min1'];
      vm.min5 = stats['min5'];
      vm.min15 = stats['min15'];
    });

    this.getDecoration = function(value) {
    if(_view[value] === undefined) {
        return;
    }

    return _view[value].decoration.toLowerCase();
};
}

'use strict';

glancesApp.component('glancesPluginMem', {
    controller: GlancesPluginMemController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-mem/view.html'
});

'use strict';

function GlancesPluginMemController($scope) {
    var vm = this;
    var _view = {};

    vm.percent = null;
    vm.total = null;
    vm.used = null;
    vm.free = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['mem'];
      _view = data.view['mem'];

      vm.percent = stats['percent'];
      vm.total = stats['total'];
      vm.used = stats['used'];
      vm.free = stats['free'];
    });

    this.getDecoration = function (value) {
        if (_view[value] === undefined) {
            return;
        }

        return _view[value].decoration.toLowerCase();
    };
}

'use strict';

glancesApp.component('glancesPluginMemMore', {
    controller: GlancesPluginMemMoreController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-mem-more/view.html'
});

'use strict';

function GlancesPluginMemMoreController($scope) {
    var vm = this;

    vm.active = null;
    vm.inactive = null;
    vm.buffers = null;
    vm.cached = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['mem'];

      vm.active = stats['active'];
      vm.inactive = stats['inactive'];
      vm.buffers = stats['buffers'];
      vm.cached = stats['cached'];
    });
}

'use strict';

glancesApp.component('glancesPluginMemswap', {
    controller: GlancesPluginMemswapController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-memswap/view.html'
});

'use strict';

function GlancesPluginMemswapController($scope) {
    var vm = this;
    var _view = {};

    vm.percent = null;
    vm.total = null;
    vm.used = null;
    vm.free = null;

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['memswap'];
      _view = data.view['memswap'];

      vm.percent = stats['percent'];
      vm.total = stats['total'];
      vm.used = stats['used'];
      vm.free = stats['free'];
    });

    this.getDecoration = function (value) {
        if (_view[value] === undefined) {
            return;
        }

        return _view[value].decoration.toLowerCase();
    };
}

'use strict';

glancesApp.component('glancesPluginNetwork', {
    controller: GlancesPluginNetworkController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-network/view.html'
});

'use strict';

function GlancesPluginNetworkController($scope, $filter, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;

    vm.networks = [];

    $scope.$on('data_refreshed', function(event, data) {
      var networkStats = data.stats['network'];

      vm.networks = [];
      for (var i = 0; i < networkStats.length; i++) {
          var networkData = networkStats[i];

          var network = {
              'interfaceName': networkData['interface_name'],
              'rx': networkData['rx'],
              'tx': networkData['tx'],
              'cx': networkData['cx'],
              'time_since_update': networkData['time_since_update'],
              'cumulativeRx': networkData['cumulative_rx'],
              'cumulativeTx': networkData['cumulative_tx'],
              'cumulativeCx': networkData['cumulative_cx']
          };

          vm.networks.push(network);
      }

      vm.networks = $filter('orderBy')(vm.networks, 'interfaceName');
    });
}

'use strict';

glancesApp.component('glancesPluginPercpu', {
    controller: GlancesPluginPercpuController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-percpu/view.html'
});

'use strict';

function GlancesPluginPercpuController($scope, GlancesPluginHelper) {
    var vm = this;
    vm.cpus = [];

    $scope.$on('data_refreshed', function(event, data) {
      var percpuStats = data.stats['percpu'];

      vm.cpus = [];

      for (var i = 0; i < percpuStats.length; i++) {
          var cpuData = percpuStats[i];

          vm.cpus.push({
              'total': cpuData.total,
              'user': cpuData.user,
              'system': cpuData.system,
              'idle': cpuData.idle,
              'iowait': cpuData.iowait,
              'steal': cpuData.steal
          });
      }
    });

    vm.getUserAlert = function(cpu) {
        return GlancesPluginHelper.getAlert('percpu', 'percpu_user_', cpu.user)
    };

    vm.getSystemAlert = function(cpu) {
        return GlancesPluginHelper.getAlert('percpu', 'percpu_system_', cpu.system);
    };
}

'use strict';

glancesApp.component('glancesPluginPorts', {
    controller: GlancesPluginPortsController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-ports/view.html'
});

'use strict';

function GlancesPluginPortsController($scope) {
    var vm = this;

    vm.ports = [];

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['ports'];

      vm.ports = [];
      angular.forEach(stats, function(port) {
          vm.ports.push(port);
      }, this);
    });

    vm.getDecoration = function(port) {
        if (port.status === null) {
            return 'careful';
        }

        if (port.status === false) {
            return 'critical';
        }

        if (port.rtt_warning !== null && port.status > port.rtt_warning) {
            return 'warning';
        }

        return 'ok';
    };
}

'use strict';

glancesApp.component('glancesPluginProcess', {
    controller: GlancesPluginProcessController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-process/view.html'
});

'use strict';

function GlancesPluginProcessController(ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;

    vm.sorter = {
        column: "cpu_percent",
        auto: true,
        isReverseColumn: function (column) {
            return !(column === 'username' || column === 'name');
        },
        getColumnLabel: function (column) {
            if (_.isEqual(column, ['io_read', 'io_write'])) {
                return 'io_counters';
            } else {
                return column;
            }
        }
    };
}

'use strict';

glancesApp.component('glancesPluginProcesscount', {
    controller: GlancesPluginProcesscountController,
    controllerAs: 'vm',
    bindings: {
        sorter: '<'
    },
    templateUrl: 'components/plugin-processcount/view.html'
});

'use strict';

function GlancesPluginProcesscountController($scope) {
    var vm = this;

    vm.total  = null;
    vm.running = null;
    vm.sleeping = null;
    vm.stopped = null;
    vm.thread = null;

    $scope.$on('data_refreshed', function(event, data) {
      var processcountStats = data.stats['processcount'];

      vm.total = processcountStats['total'] || 0;
      vm.running = processcountStats['running'] || 0;
      vm.sleeping = processcountStats['sleeping'] || 0;
      vm.stopped = processcountStats['stopped'] || 0;
      vm.thread = processcountStats['thread'] || 0;
    });
}

'use strict';

glancesApp.component('glancesPluginProcesslist', {
    controller: GlancesPluginProcesslistController,
    controllerAs: 'vm',
    bindings: {
        sorter: '<'
    },
    templateUrl: 'components/plugin-processlist/view.html'
});

'use strict';

function GlancesPluginProcesslistController($scope, GlancesPluginHelper, $filter, CONFIG, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;

    vm.processes = [];
    vm.ioReadWritePresent = false;

    $scope.$on('data_refreshed', function(event, data) {
      var processlistStats = data.stats['processlist'];

      vm.processes = [];
      vm.ioReadWritePresent = false;

      for (var i = 0; i < processlistStats.length; i++) {
          var process = processlistStats[i];

          process.memvirt = process.memory_info[1];
          process.memres  = process.memory_info[0];
          process.timeplus = $filter('timedelta')(process.cpu_times);
          process.timemillis = $filter('timemillis')(process.cpu_times);

          process.ioRead = null;
          process.ioWrite = null;

          if (process.io_counters) {
              vm.ioReadWritePresent = true;

              process.ioRead  = (process.io_counters[0] - process.io_counters[2]) / process.time_since_update;

              if (process.ioRead != 0) {
                  process.ioRead = $filter('bytes')(process.ioRead);
              }

              process.ioWrite = (process.io_counters[1] - process.io_counters[3]) / process.time_since_update;

              if (process.ioWrite != 0) {
                  process.ioWrite = $filter('bytes')(process.ioWrite);
              }
          }

          process.isNice = process.nice !== undefined && ((data.stats.isWindows && process.nice != 32) || (!data.stats.isWindows && process.nice != 0));

          if (Array.isArray(process.cmdline)) {
              process.cmdline = process.cmdline.join(' ');
          }

          vm.processes.push(process);
      }
    });

    vm.getCpuPercentAlert = function(process) {
        return GlancesPluginHelper.getAlert('processlist', 'processlist_cpu_', process.cpu_percent);
    };

    vm.getMemoryPercentAlert = function(process) {
        return GlancesPluginHelper.getAlert('processlist', 'processlist_mem_', process.cpu_percent);
    };

    vm.getLimit = function() {
        return CONFIG.outputs !== undefined ? CONFIG.outputs.max_processes_display : undefined;
    };
}

'use strict';

glancesApp.component('glancesPluginQuicklook', {
    controller: GlancesPluginQuicklookController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-quicklook/view.html'
});

'use strict';

function GlancesPluginQuicklookController($scope, ARGUMENTS) {
    var vm = this;
    vm.arguments = ARGUMENTS;
    var _view = {};

    vm.mem = null;
    vm.cpu = null;
    vm.cpu_name = null;
    vm.cpu_hz_current = null;
    vm.cpu_hz = null;
    vm.swap = null;
    vm.percpus = [];

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['quicklook'];
      _view = data.view['quicklook'];

      vm.mem = stats.mem;
      vm.cpu = stats.cpu;
      vm.cpu_name = stats.cpu_name;
      vm.cpu_hz_current = stats.cpu_hz_current;
      vm.cpu_hz = stats.cpu_hz;
      vm.swap = stats.swap;
      vm.percpus = [];

      angular.forEach(stats.percpu, function(cpu) {
          vm.percpus.push({
              'number': cpu.cpu_number,
              'total': cpu.total
          });
      }, this);
    });

    this.getDecoration = function (value) {
        if (_view[value] === undefined) {
            return;
        }

        return _view[value].decoration.toLowerCase();
    };
}

'use strict';

glancesApp.component('glancesPluginSystem', {
    controller: GlancesPluginSystemController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-system/view.html'
});

'use strict';

function GlancesPluginSystemController($scope) {
    var vm = this;

    vm.hostname = null;
    vm.platform = null;
    vm.humanReadableName = null;
    vm.os = {
        'name': null,
        'version': null
    };

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['system'];

      vm.hostname = stats['hostname'];
      vm.platform = stats['platform'];
      vm.os.name = stats['os_name'];
      vm.os.version = stats['os_version'];
      vm.humanReadableName = stats['hr_name'];
      vm.isDisconnected = false;
    });

    $scope.$on('is_disconnected', function() {
      vm.isDisconnected = true;
    });
}

'use strict';

glancesApp.component('glancesPluginUptime', {
    controller: GlancesPluginUptimeController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-uptime/view.html'
});

'use strict';

function GlancesPluginUptimeController($scope) {
    var vm = this;
    vm.value = null;

    $scope.$on('data_refreshed', function(event, data) {
      vm.value = data.stats['uptime'];
    });
}

'use strict';

glancesApp.component('glancesPluginWifi', {
    controller: GlancesPluginWifiController,
    controllerAs: 'vm',
    templateUrl: 'components/plugin-wifi/view.html'
});

'use strict';

function GlancesPluginWifiController($scope, $filter) {
    var vm = this;
    var _view = {};

    vm.hotspots = [];

    $scope.$on('data_refreshed', function(event, data) {
      var stats = data.stats['wifi'];
      _view = data.view['wifi'];

      vm.hotspots = [];
      for (var i = 0; i < stats.length; i++) {
          var hotspotData = stats[i];

          if (hotspotData['ssid'] === '') {
              continue;
          }

          vm.hotspots.push({
              'ssid': hotspotData['ssid'],
              'encrypted': hotspotData['encrypted'],
              'signal': hotspotData['signal'],
              'encryption_type': hotspotData['encryption_type']
          });
      }

      vm.hotspots = $filter('orderBy')(vm.hotspots, 'ssid');
    });

    vm.getDecoration = function(hotpost, field) {
        if(_view[hotpost.ssid][field] == undefined) {
            return;
        }

        return _view[hotpost.ssid][field].decoration.toLowerCase();
    };
}
